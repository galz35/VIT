PARTE 20 â€“ SincronizaciÃ³n Total MÃ³vil â†” Backend: Consistencia, Resiliencia y ProtecciÃ³n de Datos

Este mÃ³dulo garantiza que los datos generados offline (tareas, check-ins, formularios, alertas) se sincronicen de forma segura, sin duplicados, con integridad y control.

ğŸ” 20.1 â€“ Â¿QuÃ© se sincroniza?
Tabla local	Entidad servidor
tracking_local	/api/tracking
checkins_local	/api/checkins
formularios_local	/api/respuestas
archivos_local	/api/archivos/upload
alertas_local	/api/alertas
checkouts_local	/api/checkouts
ğŸ§  20.2 â€“ LÃ³gica del servicio SyncService

Recorre cada tabla con estado = 'PENDIENTE'

Intenta enviar al endpoint correspondiente

Si es exitoso:

Marca como ENVIADO

Registra en sync_log

Si falla:

Reintenta con backoff exponencial

Registra error en sync_log

ğŸ” 20.3 â€“ ProtecciÃ³n contra duplicados

Cada entidad enviada incluye uuid Ãºnico

Backend verifica si ya existe

if (await existeFormulario(id_formulario, id_tarea)) return; // ignora duplicado


Clave compuesta o hash (SHA256 del payload) puede ayudar a evitar dobles envÃ­os

ğŸ› ï¸ 20.4 â€“ Control de errores y colisiones
Campos en sync_log:
Campo	Detalle
modulo	checkin, formulario, alerta
id_objeto	UUID
resultado	OK / ERROR
mensaje_error	stack o cÃ³digo HTTP
fecha_sync	ISO

Si hay error permanente (ej. 401, 404), se marca como INVALIDO

Solo reintenta los errores temporales (500, timeout, network)

ğŸ“¶ 20.5 â€“ Flujo de sincronizaciÃ³n
await TrackingSync().sync();
await CheckinSync().sync();
await FormularioSync().sync();
await ArchivoSync().sync();
await AlertaSync().sync();
await CheckoutSync().sync();


Este ciclo puede correr al reconectarse a internet o en Workmanager cada X minutos.

ğŸ§ª 20.6 â€“ ValidaciÃ³n de integridad

Payload firmado con hash para auditorÃ­a

Campos crÃ­ticos no pueden estar vacÃ­os (lat, id_usuario, etc.)

Rechazo inmediato si falta auth token vÃ¡lido

ğŸ“¤ 20.7 â€“ Prioridad de envÃ­o
Tipo	Prioridad
Alertas	ğŸ”´ Alta
Formularios	ğŸŸ¡ Media
Tracking	âšªï¸ Baja
Archivos	ğŸŸ¡ Media

Las alertas se envÃ­an inmediatamente si hay conexiÃ³n, antes que otros datos.

ğŸ“Š 20.8 â€“ Web: Log de sincronizaciÃ³n

Ruta: /admin/sync-log

Tabla por mÃ³dulo

Filtros por usuario, fecha, estado

Tooltip con mensaje de error

OpciÃ³n de reintento manual