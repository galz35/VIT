# ğŸ“˜ TECHNICAL_FUSION_PLAN.md

## ğŸ¯ Objetivo
Fusionar el sistema existente **Planner-EF** con las funcionalidades de Mobile Suit Case, manteniendo su nÃºcleo de planificaciÃ³n diaria pero incorporando visitas geolocalizadas, evidencia de campo y control total por usuario.

---

## âœ… Estado Base de Planner-EF

- Agenda diaria y planificaciÃ³n ya implementadas
- Formularios dinÃ¡micos + respuestas en Flutter
- Backend con NestJS + SQL Server
- Modo offline con sincronizaciÃ³n inteligente (`sync_queue`)
- Flutter con coordenadas, adjuntos, firma y lÃ³gica modular

---

## ğŸ§© Extensiones Clave Implementar (Mobile Suit Case)

### 1. **Tabla nueva: `visitas_clientes`**
| Campo          | Tipo     |
|----------------|----------|
| id_visita      | UUID     |
| id_cliente     | UUID     |
| id_usuario     | UUID     |
| lat_inicio     | FLOAT    |
| lng_inicio     | FLOAT    |
| lat_fin        | FLOAT    |
| lng_fin        | FLOAT    |
| inicio_ts      | DATETIME |
| fin_ts         | DATETIME |
| estado         | TEXT     |
| comentario     | TEXT     |
| firma_path     | TEXT     |
| foto_path      | TEXT     |

### 2. **SP: `sp_RegistrarVisitaCliente` + `sp_FinalizarVisitaCliente`**
Valida geofence, registra tiempos, adjuntos y estado.

### 3. **Flutter: Nueva vista `/visita_cliente`**
- Captura check-in, formulario, firma, foto, check-out
- Guarda en SQLite â†’ sincroniza luego

### 4. **React Web: Panel `/visitas`**
- Filtros: por fecha, cliente, estado
- Vista mapa con pines de check-in/out
- Modal con evidencia y formularios llenados

### 5. **Multimedia `.webp` por defecto**
- CompresiÃ³n con `flutter_image_compress`
- ValidaciÃ³n backend: solo `image/webp`

---

## ğŸ”’ MÃ³dulo Avanzado de Visibilidad por Usuario

### 1. **Tabla: `usuarios_vistas`**
| Campo        | Tipo   |
|--------------|--------|
| id_usuario   | UUID   |
| plataforma   | TEXT   |
| vista        | TEXT   |
| permitido    | BOOL   |

### 2. **Endpoints API**
- `GET /api/usuarios/:id/vistas?plataforma=web`
- `PUT /api/usuarios/:id/vistas`

### 3. **Web (React)**
- Hook: `useVistaPermitida('visitas')`
- Componente `<AccessControlVista vista="visitas">...</AccessControlVista>`

### 4. **Flutter**
- Permisos enviados al login
- EvaluaciÃ³n local para mostrar/bloquear vistas

### 5. **Panel Admin**
- Ruta `/usuarios/:id/permisos-vistas`
- Switch por vista y plataforma

---

## ğŸ”„ FusiÃ³n con `agenda_dia`

- Si se quiere: agregar `id_agenda` en `visitas_clientes`
- AsÃ­ una tarea del dÃ­a puede generar una visita fÃ­sica con GPS

---

## ğŸ”š MÃ³dulo de Marcaje Web (Entrada/Salida con GPS)

### ğŸ§± Tabla nueva: `marcajes_web`
| Campo             | Tipo     |
|-------------------|----------|
| id_marcaje        | UUID     |
| id_usuario        | UUID     |
| tipo              | TEXT     | ('ENTRADA' o 'SALIDA')
| fecha_hora        | DATETIME |
| latitud           | FLOAT    |
| longitud          | FLOAT    |
| ip_origen         | TEXT     |
| user_agent        | TEXT     |
| comentario        | TEXT     |
| valido            | BOOL     | (marca vÃ¡lida o irregular)
| reclamado         | BOOL     | (el usuario pidiÃ³ correcciÃ³n)
| fecha_marcaje_dia | DATE     | DÃ­a base que representa (para detecciÃ³n de omisiÃ³n de salida)


### ğŸŒ Web (React) - Vista `/marcaje`
- Muestra hora actual
- BotÃ³n **"Marcar Entrada"** / **"Marcar Salida"**
- Captura GPS navegador (HTML5)
- ValidaciÃ³n backend:
  - No puede marcar salida antes de 5 minutos
  - No puede hacer ambas en el mismo minuto
  - Si no marcÃ³ salida dÃ­a anterior â†’ muestra botÃ³n â€œRegistrar salida pendiente dÃ­a anteriorâ€

### â®ï¸ ReclamaciÃ³n de marcaje
- BotÃ³n â€œReclamar marcajeâ€ si marcÃ³ mal
- En backend se marca `reclamado = true`
- Admin puede auditar o corregir desde el panel

### ğŸ” Rescate automÃ¡tico si no marcÃ³ salida
- En login de dÃ­a siguiente:
  - App o Web detecta que tiene `tipo=ENTRADA` sin `SALIDA`
  - Ofrece registrar salida tardÃ­a con motivo obligatorio

### ğŸ” Seguridad
- Permiso `marcaje_web` requerido
- LÃ³gica de zona geogrÃ¡fica (si aplica)
- IP y navegador auditados

---

## ğŸ“Š Progreso Actual

- FusiÃ³n tÃ©cnica lograda al **91%**
- Con estas dos extensiones: llegÃ¡s a un **100% funcional + controlado por usuario**

---

## ğŸš€ PrÃ³ximos pasos sugeridos

1. Crear migraciones o scripts SQL para nuevas tablas y SP
2. Implementar vista de visita y marcaje en Flutter y React
3. Activar control por vista (`usuarios_vistas`) desde login
4. Documentar reglas de validaciÃ³n y lÃ³gica en Swagger

---

**Este documento puede ser compartido con tu equipo de desarrollo o IA avanzada (Codex, ChatGPT 5.2, etc).**
