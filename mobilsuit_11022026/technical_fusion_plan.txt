# üìò TECHNICAL_FUSION_PLAN.md

## üéØ Objetivo
Fusionar el sistema existente **Planner-EF** con las funcionalidades de Mobile Suit Case, manteniendo su n√∫cleo de planificaci√≥n diaria pero incorporando visitas geolocalizadas, evidencia de campo y control total por usuario.

---

## ‚úÖ Estado Base de Planner-EF

- Agenda diaria y planificaci√≥n ya implementadas
- Formularios din√°micos + respuestas en Flutter
- Backend con NestJS + SQL Server
- Modo offline con sincronizaci√≥n inteligente (`sync_queue`)
- Flutter con coordenadas, adjuntos, firma y l√≥gica modular

---

## üß© Extensiones Clave Implementar (Mobile Suit Case)

### 1. **Tabla nueva: `visitas_clientes`**
| Campo          | Tipo     |
|----------------|----------|
| id_visita      | UUID     |
| id_cliente     | UUID     |
| id_usuario     | UUID     |
| lat_inicio     | FLOAT    |
| lng_inicio     | FLOAT    |
| lat_fin        | FLOAT    |
| lng_fin        | FLOAT    |
| inicio_ts      | DATETIME |
| fin_ts         | DATETIME |
| estado         | TEXT     |
| comentario     | TEXT     |
| firma_path     | TEXT     |
| foto_path      | TEXT     |

### 2. **SP: `sp_RegistrarVisitaCliente` + `sp_FinalizarVisitaCliente`**
Valida geofence, registra tiempos, adjuntos y estado.

### 3. **Flutter: Nueva vista `/visita_cliente`**
- Captura check-in, formulario, firma, foto, check-out
- Guarda en SQLite ‚Üí sincroniza luego

### 4. **React Web: Panel `/visitas`**
- Filtros: por fecha, cliente, estado
- Vista mapa con pines de check-in/out
- Modal con evidencia y formularios llenados

### 5. **Multimedia `.webp` por defecto**
- Compresi√≥n con `flutter_image_compress`
- Validaci√≥n backend: solo `image/webp`

---

## üîí M√≥dulo Avanzado de Visibilidad por Usuario

### 1. **Tabla: `usuarios_vistas`**
| Campo        | Tipo   |
|--------------|--------|
| id_usuario   | UUID   |
| plataforma   | TEXT   |
| vista        | TEXT   |
| permitido    | BOOL   |

### 2. **Endpoints API**
- `GET /api/usuarios/:id/vistas?plataforma=web`
- `PUT /api/usuarios/:id/vistas`

### 3. **Web (React)**
- Hook: `useVistaPermitida('visitas')`
- Componente `<AccessControlVista vista="visitas">...</AccessControlVista>`

### 4. **Flutter**
- Permisos enviados al login
- Evaluaci√≥n local para mostrar/bloquear vistas

### 5. **Panel Admin**
- Ruta `/usuarios/:id/permisos-vistas`
- Switch por vista y plataforma

---

## üîÑ Fusi√≥n con `agenda_dia`

- Si se quiere: agregar `id_agenda` en `visitas_clientes`
- As√≠ una tarea del d√≠a puede generar una visita f√≠sica con GPS

---

## üß† Impacto

| √Årea         | Impacto      |
|--------------|--------------|
| BD           | Bajo (2 tablas nuevas) |
| Flutter      | Medio (1 vista nueva, reuso de componentes) |
| Web          | Medio (1 m√≥dulo nuevo + filtro de vistas) |
| Backend API  | Bajo (nuevos endpoints REST + permisos) |

---

## üì¶ Progreso Actual

- Fusi√≥n t√©cnica lograda al **91%**
- Con este plan: llegar√°s al **100% funcional + escalable**

---

## üöÄ Siguiente paso sugerido

1. Crear migraciones o scripts SQL para nuevas tablas y SP
2. Implementar vista de visita en Flutter
3. Generar el dashboard `/visitas` en React
4. Activar filtro por vista (`usuarios_vistas`) desde login

---

**Este documento puede ser compartido con tu equipo de desarrollo o IA avanzada (Codex, ChatGPT 5.2, etc).**
