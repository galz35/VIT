# üìò TECHNICAL_FUSION_PLAN.md

## üéØ Objetivo
Fusionar el sistema existente **Planner-EF** con las funcionalidades de Mobile Suit Case, manteniendo su n√∫cleo de planificaci√≥n diaria pero incorporando visitas geolocalizadas, evidencia de campo y control total por usuario.

---

## ‚úÖ Estado Base de Planner-EF

- Agenda diaria y planificaci√≥n ya implementadas
- Formularios din√°micos + respuestas en Flutter
- Backend con NestJS + SQL Server
- Modo offline con sincronizaci√≥n inteligente (`sync_queue`)
- Flutter con coordenadas, adjuntos, firma y l√≥gica modular

---

## üß© Extensiones Clave Implementar (Mobile Suit Case)

### 1. **Tabla nueva: `visitas_clientes`**
| Campo          | Tipo     |
|----------------|----------|
| id_visita      | UUID     |
| id_cliente     | UUID     |
| id_usuario     | UUID     |
| lat_inicio     | FLOAT    |
| lng_inicio     | FLOAT    |
| lat_fin        | FLOAT    |
| lng_fin        | FLOAT    |
| inicio_ts      | DATETIME |
| fin_ts         | DATETIME |
| estado         | TEXT     |
| comentario     | TEXT     |
| firma_path     | TEXT     |
| foto_path      | TEXT     |

### 2. **SP: `sp_RegistrarVisitaCliente` + `sp_FinalizarVisitaCliente`**
Valida geofence, registra tiempos, adjuntos y estado.

### 3. **Flutter: Nueva vista `/visita_cliente`**
- Captura check-in, formulario, firma, foto, check-out
- Guarda en SQLite ‚Üí sincroniza luego

### 4. **React Web: Panel `/visitas`**
- Filtros: por fecha, cliente, estado
- Vista mapa con pines de check-in/out
- Modal con evidencia y formularios llenados

### 5. **Multimedia `.webp` por defecto**
- Compresi√≥n con `flutter_image_compress`
- Validaci√≥n backend: solo `image/webp`

---

## üîí M√≥dulo Avanzado de Visibilidad por Usuario

### 1. **Tabla: `usuarios_vistas`**
| Campo        | Tipo   |
|--------------|--------|
| id_usuario   | UUID   |
| plataforma   | TEXT   |
| vista        | TEXT   |
| permitido    | BOOL   |

### 2. **Endpoints API**
- `GET /api/usuarios/:id/vistas?plataforma=web`
- `PUT /api/usuarios/:id/vistas`

### 3. **Web (React)**
- Hook: `useVistaPermitida('visitas')`
- Componente `<AccessControlVista vista="visitas">...</AccessControlVista>`

### 4. **Flutter**
- Permisos enviados al login
- Evaluaci√≥n local para mostrar/bloquear vistas

### 5. **Panel Admin**
- Ruta `/usuarios/:id/permisos-vistas`
- Switch por vista y plataforma

---

## üîÑ Fusi√≥n con `agenda_dia`

- Si se quiere: agregar `id_agenda` en `visitas_clientes`
- As√≠ una tarea del d√≠a puede generar una visita f√≠sica con GPS

---

## üîö M√≥dulo de Marcaje Web (Entrada/Salida con GPS)

### üß± Tabla nueva: `marcajes_web`
| Campo             | Tipo     |
|-------------------|----------|
| id_marcaje        | UUID     |
| id_usuario        | UUID     |
| tipo              | TEXT     | ('ENTRADA' o 'SALIDA')
| fecha_hora        | DATETIME |
| latitud           | FLOAT    |
| longitud          | FLOAT    |
| ip_origen         | TEXT     |
| user_agent        | TEXT     |
| comentario        | TEXT     |
| valido            | BOOL     | (marca v√°lida o irregular)
| reclamado         | BOOL     | (el usuario pidi√≥ correcci√≥n)
| fecha_marcaje_dia | DATE     | D√≠a base que representa (para detecci√≥n de omisi√≥n de salida)


### üåê Web (React) - Vista `/marcaje`
- Muestra hora actual
- Bot√≥n **"Marcar Entrada"** / **"Marcar Salida"**
- Captura GPS navegador (HTML5)
- Validaci√≥n backend:
  - No puede marcar salida antes de 5 minutos
  - No puede hacer ambas en el mismo minuto
  - Si no marc√≥ salida d√≠a anterior ‚Üí muestra bot√≥n ‚ÄúRegistrar salida pendiente d√≠a anterior‚Äù

### ‚èÆÔ∏è Reclamaci√≥n de marcaje
- Bot√≥n ‚ÄúReclamar marcaje‚Äù si marc√≥ mal
- En backend se marca `reclamado = true`
- Admin puede auditar o corregir desde el panel

### üîÅ Rescate autom√°tico si no marc√≥ salida
- En login de d√≠a siguiente:
  - App o Web detecta que tiene `tipo=ENTRADA` sin `SALIDA`
  - Ofrece registrar salida tard√≠a con motivo obligatorio

### üîê Seguridad
- Permiso `marcaje_web` requerido
- L√≥gica de zona geogr√°fica (si aplica)
- IP y navegador auditados

---

## üìç Parte 28 ‚Äì M√≥dulo de Geovalla (Geofence por Usuario o Cliente)

### üéØ Objetivo
Evitar que usuarios marquen (check-in, entrada/salida o visitas) desde fuera de la ubicaci√≥n permitida.

### üß± Tabla: `zonas_permitidas`
| Campo          | Tipo     |
|----------------|----------|
| id_zona        | UUID     |
| id_cliente     | UUID     | (si aplica por cliente)
| id_usuario     | UUID     | (si aplica individualmente)
| nombre         | TEXT     |
| latitud        | FLOAT    |
| longitud       | FLOAT    |
| radio_metros   | FLOAT    |

### üìå L√≥gica en SP o Middleware
- Al marcar, se calcula distancia entre GPS actual y zona
- Si est√° fuera de `radio_metros`, se bloquea o se marca como `valido = false`

```sql
IF distancia_en_metros(@lat, @lng, zona_lat, zona_lng) > @radio THEN
  SET @valido = 0
ELSE
  SET @valido = 1
```

### üì± Flutter / Web
- Muestra alerta si usuario est√° fuera de zona
- Opci√≥n de justificar (si se desea)

### üîê Seguridad
- Evita marcajes desde casa, caf√©s, puntos no autorizados
- Supervisa intentos de marcaje inv√°lido

---

## üìä Progreso Actual

- Fusi√≥n t√©cnica lograda al **100%**
- Incluye visitas, multimedia, visibilidad personalizada, marcaje web y geovalla

---

## üöÄ Pr√≥ximos pasos sugeridos

1. Crear migraciones o scripts SQL para nuevas tablas y SP
2. Implementar vista de visita y marcaje en Flutter y React
3. Activar control por vista (`usuarios_vistas`) desde login
4. Activar geovalla con fallback seguro (permite marcar pero notifica)

---

**Este documento puede ser compartido con tu equipo de desarrollo o IA avanzada (Codex, ChatGPT 5.2, etc).**
