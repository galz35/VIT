PARTE 9 â€“ Firma Digital y Adjuntos: Captura, ValidaciÃ³n y EnvÃ­o Seguro

Este mÃ³dulo permite firmar formularios, capturar evidencias (fotos, firmas) y enviarlas como archivos junto a los datos estructurados.

ğŸ–Šï¸ 9.1 â€“ Firma Digital (Flutter)
ğŸ“¦ LibrerÃ­a: signature
dependencies:
  signature: ^5.2.1

ğŸ¯ Uso en Widget
final SignatureController _controller = SignatureController(
  penStrokeWidth: 3,
  penColor: Colors.black,
  exportBackgroundColor: Colors.white,
);

Signature(
  controller: _controller,
  height: 250,
  backgroundColor: Colors.grey[200]!,
),

ğŸ’¾ Guardar como imagen
final Uint8List? data = await _controller.toPngBytes();
final file = File('${tempDir.path}/firma_${uuid.v4()}.png');
await file.writeAsBytes(data!);


El archivo queda registrado en archivos_local con tipo = 'firma', id_origen = id_formulario.

ğŸ“¸ 9.2 â€“ Captura de Foto (Evidencia Visual)
ğŸ“¦ LibrerÃ­a: image_picker
final XFile? foto = await ImagePicker().pickImage(source: ImageSource.camera);
final path = foto?.path;


TambiÃ©n se guarda en archivos_local

Puede ser obligatorio si el tipo de formulario lo requiere

ğŸ§¾ 9.3 â€“ Registro en SQLite
INSERT INTO archivos_local (
  ruta_local,
  tipo,
  entidad_origen,
  id_origen,
  timestamp,
  estado
) VALUES (?, ?, ?, ?, ?, 'PENDIENTE');

Campo	Valor
ruta_local	file.path
tipo	'firma' / 'foto'
entidad_origen	'formulario' / 'checkin'
id_origen	ID relacionado
timestamp	Fecha de captura
ğŸ“¤ 9.4 â€“ EnvÃ­o al Backend (NestJS)
ğŸ“¦ Uso de FormData con dio
final file = await MultipartFile.fromFile(path, filename: basename(path));

final form = FormData.fromMap({
  'id_origen': id,
  'entidad_origen': 'formulario',
  'tipo': 'firma',
  'archivo': file,
});

final res = await dio.post('/api/archivos/subir', data: form);

ğŸ”’ Seguridad

TamaÃ±o mÃ¡x. configurado: 5MB

Backend valida:

archivo.mimetype permitido (image/png, image/jpeg)

TamaÃ±o

ID origen vÃ¡lido y usuario propietario

ğŸ‘ï¸ 9.5 â€“ Vista previa (App y Web)
Flutter
Image.file(File(rutaLocal)); // previa de firma o foto

React Web (Panel Admin)
<img src={`https://api.com/archivos/view/${archivoId}`} width={200} />

ğŸ“„ 9.6 â€“ Backend: Guardado y Acceso
Carpeta	Uso
/archivos/formularios/{id}/firma.png	Firmas
/archivos/formularios/{id}/foto1.jpg	Evidencias

La API de backend (NestJS) sirve las imÃ¡genes con headers de seguridad y sin indexaciÃ³n pÃºblica.