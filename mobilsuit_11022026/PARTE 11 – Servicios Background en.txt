PARTE 11 â€“ Servicios Background en Flutter: Tracking, ReconexiÃ³n y Auto-Sync

Estos servicios permiten que la app funcione de forma autÃ³noma y persistente, incluso si estÃ¡ minimizada o cerrada.

âš™ï¸ 11.1 â€“ Requisitos TÃ©cnicos
âœ… Plugins Necesarios
dependencies:
  workmanager: ^0.5.1
  connectivity_plus: ^5.0.1
  geolocator: ^10.1.0
  flutter_background: ^1.2.0
  permission_handler: ^11.0.1

ğŸ—ºï¸ 11.2 â€“ Servicio de Tracking GPS
ğŸ§  LÃ³gica

Se ejecuta cada N minutos (configurable)

Toma la coordenada actual con precisiÃ³n

La guarda en tracking_local si no hay conexiÃ³n

Intenta enviar si estÃ¡ online

ğŸ› ï¸ Registro del Servicio
void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Workmanager().initialize(callbackDispatcher, isInDebugMode: false);
  await Workmanager().registerPeriodicTask(
    'track-task',
    'trackingBackground',
    frequency: const Duration(minutes: 5),
  );
  runApp(MyApp());
}

ğŸ”„ callbackDispatcher
void callbackDispatcher() {
  Workmanager().executeTask((task, inputData) async {
    final position = await Geolocator.getCurrentPosition();
    final bateria = await Battery().batteryLevel;

    await TrackingDao.insertar(TrackingLocal(
      lat: position.latitude,
      lng: position.longitude,
      precision: position.accuracy.toInt(),
      velocidad: position.speed,
      bateria: bateria,
      timestamp: DateTime.now().toIso8601String(),
      estado: 'PENDIENTE'
    ));

    final conectado = await Connectivity().checkConnectivity();
    if (conectado != ConnectivityResult.none) {
      await TrackingSync().sync(); // reintento automÃ¡tico
    }

    return true;
  });
}

ğŸ” 11.3 â€“ Auto Sync al reconectarse
void setupConnectivityListener() {
  Connectivity().onConnectivityChanged.listen((result) async {
    if (result != ConnectivityResult.none) {
      await SyncService().sincronizarTodo();
    }
  });
}


Este cÃ³digo se ejecuta al iniciar la app (por ejemplo, en main() o SplashPage).

ğŸ§¯ 11.4 â€“ Permisos Necesarios
AndroidManifest.xml
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
<uses-permission android:name="android.permission.FOREGROUND_SERVICE" />

Solicitud Flutter
await Permission.locationAlways.request();
await Permission.ignoreBatteryOptimizations.request();

ğŸ”‹ 11.5 â€“ Soporte para fondo persistente (Android)
await FlutterBackground.initialize();
await FlutterBackground.enableBackgroundExecution();

ğŸ”’ Seguridad

Si el usuario cierra sesiÃ³n â†’ se desactiva el worker

El worker no accede a funciones si no hay id_usuario activo en local