PARTE 8 â€“ Seguridad e Identidad (Flutter, Backend, React)

Asegura que solo usuarios autorizados accedan, actÃºen y firmen desde dispositivos legÃ­timos, con trazabilidad y control antifraude.

ðŸ§‘â€ðŸ’¼ 8.1 â€“ Identidad del Usuario

Cada usuario tiene:

Campo	Uso
id_usuario	Identificador UUID Ãºnico
carnet	IdentificaciÃ³n empresarial obligatoria
email	Para login (puede omitirse en app mÃ³vil si se usa solo carnet)
device_id	CÃ³digo del dispositivo autorizado (hash de Android ID o UUID generado)
firma_base	Imagen/firma PNG usada para validaciÃ³n manual si se requiere
ðŸ“² 8.2 â€“ Seguridad en App Flutter
ðŸ” Almacenamiento seguro
final secure = const FlutterSecureStorage();
await secure.write(key: 'token', value: token);
await secure.write(key: 'device_id', value: uuid);


Nunca guardar el token en SharedPreferences

Si el token expira, dio interceptor lanza refresh

ðŸ›‚ ValidaciÃ³n por dispositivo

App obtiene device_id al instalar

Login envÃ­a carnet, password, device_id

Backend valida:

Â¿usuario activo?

Â¿carnet correcto?

Â¿device_id coincide con el registrado?

Si OK â†’ genera JWT

Si device_id es nuevo, permite solo si es primer login o autorizado manualmente

ðŸ” 8.3 â€“ Token JWT y Roles

El JWT incluye:

sub: ID de usuario

rol: admin, supervisor, movil

exp: tiempo de expiraciÃ³n

Flutter lo envÃ­a en cada llamada:

Authorization: Bearer {token}


Backend (NestJS):

@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('admin')

ðŸ•µï¸ 8.4 â€“ Control antifraude
Comportamiento sospechoso	AcciÃ³n
Login desde otro device	Rechazo + alerta a supervisor
Check-in fuera del radio	Registro en alertas + bloqueo si supera X metros
Firma incompleta o vacÃ­a	Formulario no se puede enviar
GPS manipulado (mock location)	Rechazo inmediato si se detecta
Cambios bruscos de posiciÃ³n	Tracking excluye puntos con velocidad > 120km/h
ðŸ§¼ 8.5 â€“ Logout forzado (seguridad remota)

Admin desactiva usuario o cambia rol en panel

App recibe error 401 o activo: false

Ejecuta:

await secure.deleteAll();
Navigator.pushReplacementNamed(context, '/login');
