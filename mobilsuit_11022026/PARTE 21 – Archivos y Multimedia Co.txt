PARTE 21 â€“ Archivos y Multimedia: CompresiÃ³n, Seguridad y EnvÃ­o desde MÃ³vil

Este mÃ³dulo permite capturar imÃ¡genes, firmas, documentos o audio desde Flutter, comprimirlos y enviarlos de forma segura al backend, respetando integridad y espacio.

ğŸ“¸ 21.1 â€“ Tipos de archivo permitidos
Tipo	Usado en...	ExtensiÃ³n	Origen
Imagen	Formularios, evidencia	.jpg/.png	CÃ¡mara o galerÃ­a
Firma	Check-out, formularios	.png	Widget de firma
Documento	Adjuntos opcionales	.pdf/.docx	Picker
Audio	Pruebas de voz (opcional)	.mp3	Grabadora
ğŸ§± 21.2 â€“ SQLite: archivos_local
Campo	Tipo	DescripciÃ³n
id	INT PK	ID local
id_origen	UUID	ID del formulario/tarea
tipo	TEXT	foto, firma, doc, audio
path_local	TEXT	Ruta interna
estado	TEXT	PENDIENTE / ENVIADO
timestamp	TEXT	ISO 8601
ğŸ§  21.3 â€“ Captura y compresiÃ³n Flutter
Imagen
final image = await ImagePicker().pickImage(source: ImageSource.camera);
final compressed = await FlutterImageCompress.compressAndGetFile(
  image.path, '${dir}/img_comprimida.jpg',
  quality: 70,
);

Firma
final signature = await controller.toPngBytes();
await File('firma_${uuid}.png').writeAsBytes(signature);

ğŸ” 21.4 â€“ EnvÃ­o seguro al backend

POST /api/archivos/upload (multipart)

Content-Type: multipart/form-data
Authorization: Bearer {token}


Cuerpo:

file: archivo binario

tipo: foto / firma / audio

id_origen: ID de la tarea/formulario asociada

nombre_original: opcional

ğŸ§Š 21.5 â€“ Almacenamiento en el backend

Se almacena en carpeta segmentada por tipo y fecha:

/evidencia/foto/2026/02/

/firmas/

Nombre hash Ãºnico: form_09284_foto_01.jpg

Registro en tabla archivos:

Campo	Detalle
uuid	ID Ãºnico
url	Path accesible
tipo	firma, foto
usuario_id	Responsable
tarea_id	Asignada
ğŸ–¥ï¸ 21.6 â€“ Vista web en reportes

Firma: preview directa

Foto: miniatura ampliable (modal)

Documento: descarga con nombre original

Audio: botÃ³n â€œescucharâ€

ğŸ§ª 21.7 â€“ Validaciones

TamaÃ±o mÃ¡ximo configurable (ej. 5 MB)

Tipo de archivo validado (Content-Type)

Archivos obligatorios (ej. firma requerida para cierre)

Se puede bloquear tareas incompletas sin archivo obligatorio
Perfecto. Se priorizarÃ¡ el uso de imÃ¡genes en formato .webp para todo tipo de evidencias visuales, dado que:

âœ… Ventajas clave de .webp:

25â€“35% mÃ¡s ligero que .jpg con calidad visual similar.

Soporte total en navegadores modernos y Flutter.

Ideal para dispositivos con almacenamiento limitado o conexiones lentas.

ğŸ”§ Ajustes para la implementaciÃ³n:
ğŸ“± En Flutter:
final image = await ImagePicker().pickImage(source: ImageSource.camera);
final webpFile = await FlutterImageCompress.compressAndGetFile(
  image.path,
  '${dir}/foto_${uuid}.webp',
  format: CompressFormat.webp,
  quality: 75,
);


Se generarÃ¡ y almacenarÃ¡ localmente como .webp

La ruta path_local en archivos_local termina en .webp

ğŸŒ En backend (NestJS + Fastify):

Validar image/webp en Content-Type

Guardar con extensiÃ³n .webp

En carpeta /evidencia/webp/yyyy/mm/

OptimizaciÃ³n de payload en frontend: menor uso de datos

ğŸ–¥ï¸ En el panel web (React):

Renderizado directo con <img src="..." /> (los browsers ya soportan .webp)

Modal preview como imagen expandida

OpciÃ³n de descarga en original .webp

El sistema sigue permitiendo .jpg y .png si alguna cÃ¡mara antigua no soporta .webp, pero el flujo por defecto ahora serÃ¡ .webp.