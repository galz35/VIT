üìò PARTE 3.1 ‚Äì Modelo de Base de Datos: Entidades Principales (SQL Server)

Esta secci√≥n define el modelo relacional base, con tablas normalizadas, claves for√°neas y relaciones esenciales.

üß© 3.1.1 ‚Äì Diagrama L√≥gico de M√≥dulos

M√≥dulos principales:

usuarios / roles

empresas / clientes

actividades (visitas/tareas)

formularios / respuestas

tracking / geocercas

alertas / p√°nico

chat / mensajes

archivos / firmas

üóÉÔ∏è 3.1.2 ‚Äì Tabla: usuarios
CREATE TABLE usuarios (
  id_usuario UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_empresa UNIQUEIDENTIFIER,
  nombre NVARCHAR(100),
  email NVARCHAR(100) UNIQUE,
  password_hash NVARCHAR(255),
  rol VARCHAR(20), -- admin/supervisor/movil
  activo BIT DEFAULT 1,
  fecha_creacion DATETIME DEFAULT GETDATE(),
  device_id NVARCHAR(100), -- m√≥vil
  CONSTRAINT FK_usuario_empresa FOREIGN KEY (id_empresa) REFERENCES empresas(id_empresa)
);

üóÇÔ∏è 3.1.3 ‚Äì Tabla: empresas
CREATE TABLE empresas (
  id_empresa UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  nombre NVARCHAR(100),
  ruc NVARCHAR(20),
  estado BIT DEFAULT 1,
  fecha_registro DATETIME DEFAULT GETDATE()
);

üìç 3.1.4 ‚Äì Tabla: clientes
CREATE TABLE clientes (
  id_cliente UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_empresa UNIQUEIDENTIFIER,
  nombre NVARCHAR(100),
  direccion NVARCHAR(200),
  lat DECIMAL(9,6),
  lng DECIMAL(9,6),
  radio_metros INT DEFAULT 50,
  activo BIT DEFAULT 1,
  CONSTRAINT FK_cliente_empresa FOREIGN KEY (id_empresa) REFERENCES empresas(id_empresa)
);

üìÖ 3.1.5 ‚Äì Tabla: actividades
CREATE TABLE actividades (
  id_actividad UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_usuario UNIQUEIDENTIFIER,
  id_cliente UNIQUEIDENTIFIER,
  fecha_asignada DATE,
  hora_inicio TIME,
  estado VARCHAR(20) DEFAULT 'pendiente', -- pendiente, en_proceso, completada, fallida
  checkin_lat DECIMAL(9,6),
  checkin_lng DECIMAL(9,6),
  checkin_ts DATETIME,
  checkout_ts DATETIME,
  observacion NVARCHAR(MAX),
  CONSTRAINT FK_act_usuario FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario),
  CONSTRAINT FK_act_cliente FOREIGN KEY (id_cliente) REFERENCES clientes(id_cliente)
);

üìë 3.1.6 ‚Äì Tabla: formularios_def
CREATE TABLE formularios_def (
  id_formulario UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  nombre NVARCHAR(100),
  version INT,
  json NVARCHAR(MAX),
  activo BIT DEFAULT 1,
  fecha_creacion DATETIME DEFAULT GETDATE()
);

‚úçÔ∏è 3.1.7 ‚Äì Tabla: respuestas_formulario
CREATE TABLE respuestas_formulario (
  id_respuesta UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_formulario UNIQUEIDENTIFIER,
  id_actividad UNIQUEIDENTIFIER,
  json_respuesta NVARCHAR(MAX),
  timestamp DATETIME DEFAULT GETDATE(),
  CONSTRAINT FK_res_form FOREIGN KEY (id_formulario) REFERENCES formularios_def(id_formulario),
  CONSTRAINT FK_res_act FOREIGN KEY (id_actividad) REFERENCES actividades(id_actividad)
);

üì° 3.1.8 ‚Äì Tabla: tracking_gps
CREATE TABLE tracking_gps (
  id_tracking UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_usuario UNIQUEIDENTIFIER,
  lat DECIMAL(9,6),
  lng DECIMAL(9,6),
  velocidad FLOAT,
  precision_metros INT,
  bateria INT,
  timestamp DATETIME,
  origen VARCHAR(20), -- foreground/background/manual
  CONSTRAINT FK_track_user FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

üö® 3.1.9 ‚Äì Tabla: alertas
CREATE TABLE alertas (
  id_alerta UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_usuario UNIQUEIDENTIFIER,
  tipo VARCHAR(30), -- panico, fuera_geocerca, inactividad
  mensaje NVARCHAR(300),
  lat DECIMAL(9,6),
  lng DECIMAL(9,6),
  atendida BIT DEFAULT 0,
  timestamp DATETIME,
  CONSTRAINT FK_alert_user FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

üí¨ 3.1.10 ‚Äì Tabla: mensajes_chat
CREATE TABLE mensajes_chat (
  id_mensaje UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_remitente UNIQUEIDENTIFIER,
  id_destinatario UNIQUEIDENTIFIER NULL, -- puede ser global
  contenido NVARCHAR(MAX),
  timestamp DATETIME DEFAULT GETDATE(),
  leido BIT DEFAULT 0,
  CONSTRAINT FK_chat_de FOREIGN KEY (id_remitente) REFERENCES usuarios(id_usuario)
);
CREATE TABLE usuarios (
  id_usuario UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_empresa UNIQUEIDENTIFIER,
  carnet NVARCHAR(50) UNIQUE NOT NULL, -- Identificador interno obligatorio
  nombre NVARCHAR(100),
  email NVARCHAR(100) UNIQUE,
  password_hash NVARCHAR(255),
  rol VARCHAR(20), -- admin/supervisor/movil
  activo BIT DEFAULT 1,
  fecha_creacion DATETIME DEFAULT GETDATE(),
  device_id NVARCHAR(100), -- para m√≥vil
  CONSTRAINT FK_usuario_empresa FOREIGN KEY (id_empresa) REFERENCES empresas(id_empresa)
);
üìÅ 3.1.11 ‚Äì Tabla: archivos
CREATE TABLE archivos (
  id_archivo UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
  id_usuario UNIQUEIDENTIFIER,
  entidad_origen VARCHAR(20), -- formulario, actividad
  id_origen UNIQUEIDENTIFIER,
  tipo VARCHAR(10), -- jpg, png, mp3, pdf
  ruta NVARCHAR(300),
  timestamp DATETIME,
  CONSTRAINT FK_file_user FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);